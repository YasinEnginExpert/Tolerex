name: tolerex-lab

# Basics
topology:
  nodes:
    # ------------------------------------------------------------------
    # CORE SWITCH (Simulated Nokia SR Linux or generic Linux Bridge)
    # ------------------------------------------------------------------
    nokia-switch:
      kind: linux
      image: alpine:latest 
      cmd: sh -c "sleep infinity"
      labels:
        role: core-switch
        icon: router

    # ------------------------------------------------------------------
    # CLIENT SIMULATOR (Added as per request)
    # ------------------------------------------------------------------
    client-node:
      kind: linux
      image: tolerex-node:latest
      # Keep it alive to run manual commands
      cmd: sh -c "sleep infinity"
      labels:
        role: client
        icon: host

    # ------------------------------------------------------------------
    # LEADER NODE
    # ------------------------------------------------------------------
    leader:
      kind: linux
      image: tolerex-node:latest
      cmd: ./leader
      env:
        LEADER_GRPC_PORT: "5555"
        LEADER_METRICS_PORT: "9090"
      ports:
        # Changed host ports to avoid conflict with docker-compose
        - "5555:5555" 
        - "6667:6666" # Mapped to 6667 on host to avoid conflict
        - "9095:9090" # Mapped to 9095
      labels:
        role: leader
        icon: server

    # ------------------------------------------------------------------
    # MEMBER NODES
    # ------------------------------------------------------------------
    member1:
      kind: linux
      image: tolerex-node:latest
      cmd: ./member -port=5556 -metrics=9092 -io=buffered
      env:
        LEADER_ADDR: "leader:5555"
        MEMBER_ADDR: "member1:5556"
      ports:
        - "9096:9092"
      labels:
        role: member
        icon: database

    member2:
      kind: linux
      image: tolerex-node:latest
      cmd: ./member -port=5557 -metrics=9093 -io=buffered
      env:
        LEADER_ADDR: "leader:5555"
        MEMBER_ADDR: "member2:5557"
      ports:
        - "9097:9093"
      labels:
        role: member
        icon: database

    member3:
      kind: linux
      image: tolerex-node:latest
      cmd: ./member -port=5558 -metrics=9094 -io=buffered
      env:
        LEADER_ADDR: "leader:5555"
        MEMBER_ADDR: "member3:5558"
      ports:
        - "9098:9094"
      labels:
        role: member
        icon: database

    # ------------------------------------------------------------------
    # MONITORING STACK (Wireless Topology)
    # ------------------------------------------------------------------
    # These communicate via the Management Network (Docker Bridge)
    # We removed physical 'links' so they don't clutter the graph.
    prometheus:
      kind: linux
      image: prom/prometheus:latest
      binds:
        - prometheus.yml:/etc/prometheus/prometheus.yml:ro
      cmd: --config.file=/etc/prometheus/prometheus.yml
      # Mapped to 9099 on host to avoid conflict
      ports:
        - "9099:9090"
      labels:
        role: monitoring
        graph-hide: yes # Suggestion to hide wires if tool supports it, but purely removing links works.

    grafana:
      kind: linux
      image: grafana/grafana:latest
      env:
        GF_SECURITY_ADMIN_PASSWORD: admin
      # Mapped to 3001 on host to avoid conflict
      ports:
        - "3001:3000"
      labels:
        role: monitoring

  # ------------------------------------------------------------------
  # PHYSICAL LINKS
  # ------------------------------------------------------------------
  links:
    # Client <--> Nokia Switch
    - endpoints: ["client-node:eth1", "nokia-switch:eth1"]
    
    # Nokia Switch <--> Leader
    - endpoints: ["nokia-switch:eth2", "leader:eth1"]

    # Leader <--> Members (Backend Connections)
    - endpoints: ["leader:eth2", "member1:eth1"]
    - endpoints: ["leader:eth3", "member2:eth1"]
    - endpoints: ["leader:eth4", "member3:eth1"]

    # Prometheus & Grafana are NOT linked here.
    # They will use the implicit 'tolerex-lab-mgmt' docker network to scrape targets.
